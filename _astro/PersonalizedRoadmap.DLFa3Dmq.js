import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as a}from"./index.DatCARk7.js";import{r as O,i as D}from"./jwt.1xGNZsvU.js";import{r as $}from"./chat.C-0TRz4N.js";import{r as E}from"./index.Cfv66hal.js";import{d as A,b as U,a as y}from"./resource-progress.CNHeJjXc.js";import{M as J}from"./Modal.B1RqXaQs.js";import{a as v}from"./query-client.BXTfwa3d.js";import{a as q}from"./ai-course.C9pe4RQ2.js";import{u as S}from"./useQuery.BDS8a8wn.js";import{U as G}from"./UpgradeAccountModal.Bf1PhEwX.js";import{T as Q}from"./trash-2.B2o931ei.js";import{P as L}from"./person-standing.JwgQFf2-.js";import{c as N}from"./classname.y9b8gBZq.js";import{E as V}from"./ellipsis-vertical.CxxBP93e.js";import{P as W}from"./pencil.DCzTvCha.js";import{X}from"./x.ZVxf9pxD.js";import{u as R}from"./useMutation.BrRqCquH.js";import{a as k}from"./query-http.YhxTqNi8.js";import{u as B}from"./use-toast.BdCcSTJE.js";import{u as H}from"./use-auth.Bw1nhFr_.js";import{r as K}from"./roadmap.C9m-s_nC.js";import{s as Y}from"./popup.CdCAhVM2.js";import{L as Z}from"./loader-circle.1OH4z0ap.js";import"./js.cookie.Cz0CWeBA.js";import"./index.Bz-QvCnq.js";import"./http.qJhOBTpO.js";import"./fp.esm.D_pnqQn4.js";import"./roadmap.DwTTnFhR.js";import"./index.BHh4vvK5.js";import"./index.3whys8t3.js";import"./use-outside-click.f1LA7r1K.js";import"./use-keydown.UQ-VttR1.js";import"./billing.CdvAGjKR.js";import"./UpdatePlanConfirmation.vVGIG51-.js";import"./VerifyUpgrade.DHdhu0dP.js";import"./browser.3c2kCsRM.js";import"./circle-check-big.DD4Bg2zr.js";import"./createLucideIcon.uNyFMN5K.js";import"./zap.W9oJWPBR.js";import"./message-circle.gi35PKdE.js";import"./map.D6boQwTM.js";import"./toast.DlejBBdi.js";import"./index.BgRaT1MR.js";function _(f){const{roadmapId:o,onError:d,onStart:m,onData:u,onFinish:p}=f,i=a.useRef(null),n=a.useRef(null),[l,r]=a.useState("idle"),x=a.useRef(""),w=async h=>{try{x.current=h,m?.(),r("loading"),i.current?.abort(),i.current=new AbortController;const b=await fetch("https://api.roadmap.sh/v1-personalized-roadmap",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roadmapId:o,information:h}),signal:i.current?.signal,credentials:"include"});if(!b.ok){const j=await b.json();throw r("error"),j.status===401&&(O(),window.location.reload()),new Error(j?.message||"Something went wrong")}const P=b.body;if(!P)throw r("error"),new Error("Something went wrong");if(await $(P,{onMessage:async j=>{E.flushSync(()=>{r("streaming");const z=ee(j);n.current={...z,information:x.current},u?.(n.current)})},onMessageEnd:async()=>{E.flushSync(()=>{r("ready")})}}),r("idle"),i.current=null,!n.current)throw r("error"),new Error("Something went wrong");p?.(n.current)}catch(b){if(i.current?.signal.aborted)return;d?.(b),r("error")}},g=a.useCallback(()=>{i.current&&(i.current.abort(),i.current=null)},[]);return{status:l,stop:g,generatePersonalizedRoadmap:w}}function ee(f){const o=new Set,d=f.split(`
`);for(const m of d)if(m.trim()&&m.startsWith("-")){const u=m.slice(1).trim();if(!u)continue;o.add(u)}return{topicIds:Array.from(o)}}function re(f){const{onClose:o,info:d,onSubmit:m,onClearProgress:u}=f,[p,i]=a.useState(d),n=a.useId(),{data:l,isLoading:r}=S(q(),v),x=l?.used&&l?.limit?l.used>=l.limit:!1;console.log(l);const w=g=>{g.preventDefault(),m(p)};return x?e.jsx(G,{onClose:o}):e.jsx(J,{onClose:o,wrapperClassName:"h-auto",overlayClassName:"items-start md:items-center",bodyClassName:"rounded-2xl",children:e.jsxs("form",{onSubmit:w,className:"p-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Personalize Roadmap"}),e.jsxs("div",{className:"mt-0.5 flex flex-col gap-2",children:[e.jsx("label",{htmlFor:n,className:"text-balance text-gray-600",children:"Tell us about yourself to personlize this roadmap as per your goals and experience"}),e.jsx("textarea",{id:n,className:"h-[150px] w-full resize-none rounded-xl border border-gray-200 p-3 focus:border-gray-500 focus:outline-none",placeholder:"e.g. I am a beginner, give me a simpler version of the roadmap",value:p,onChange:g=>i(g.target.value),autoFocus:!0})]}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[e.jsxs("button",{type:"button",className:"flex items-center justify-center gap-2 rounded-xl border border-red-200 p-2 px-2 text-sm text-red-600 hover:bg-red-50 focus:outline-none",onClick:u,children:[e.jsx(Q,{className:"h-4 w-4"}),"Reset"]}),e.jsxs("button",{type:"submit",disabled:!p.trim(),className:"flex items-center justify-center gap-2 rounded-xl bg-black p-2 px-2 text-white hover:opacity-90 focus:outline-none disabled:cursor-not-allowed disabled:opacity-50",children:[e.jsx(L,{className:"h-4 w-4"}),"Personalize"]})]})]})})}function oe(f){const{isPersonalized:o,onToggle:d,onEdit:m,onRemove:u,className:p}=f,[i,n]=a.useState(!1),l=a.useRef(null);return a.useEffect(()=>{const r=x=>{l.current&&!l.current.contains(x.target)&&n(!1)};return document.addEventListener("mousedown",r),()=>{document.removeEventListener("mousedown",r)}},[]),e.jsx("div",{className:N("mb-2 flex items-center gap-2",p),children:e.jsxs("div",{className:"relative flex items-center",children:[e.jsxs("div",{className:"relative",ref:l,children:[e.jsx("button",{onClick:()=>n(!i),className:"mr-0.5 p-1 text-gray-400 hover:text-gray-600",title:"More options",children:e.jsx(V,{className:"h-3.5 w-3.5"})}),i&&e.jsxs("div",{className:"absolute top-full left-0 z-20 mt-1 rounded-md border border-gray-200 bg-white shadow-lg",children:[e.jsxs("button",{onClick:()=>{m(),n(!1)},className:"flex w-full items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100",children:[e.jsx(W,{className:"h-3.5 w-3.5"}),"Edit"]}),e.jsxs("button",{onClick:()=>{u(),n(!1)},className:"flex w-full items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50",children:[e.jsx(X,{className:"h-3.5 w-3.5"}),"Delete"]})]})]}),e.jsxs("div",{className:"flex bg-gray-200 rounded-full",children:[e.jsx("button",{className:N("rounded-full px-2.5 py-1 text-xs font-medium transition-all",o?"bg-gray-900 text-white":"text-gray-500 hover:text-gray-700"),onClick:()=>d(!0),children:"Personalized"}),e.jsx("button",{className:N("rounded-full px-2.5 py-1 text-xs font-medium transition-all",o?"text-gray-500 hover:text-gray-700":"bg-gray-900 text-white"),onClick:()=>d(!1),children:"Original"})]})]})})}function Xe(f){const{roadmapId:o}=f,d=B(),m=H(),[u,p]=a.useState(!1),[i,n]=a.useState(!1),{data:l}=S(K(o),v),{data:r,isLoading:x,refetch:w}=S(A("roadmap",o),v);a.useEffect(()=>{r?.personalized&&n(!0)},[r]);const g=a.useMemo(()=>new Set([...r?.learning??[],...r?.done??[]]),[r]),h=a.useMemo(()=>(l?.json?.nodes?.filter(t=>["topic","subtopic"].includes(t?.type??""))??[]).filter(t=>{const c=t?.id;return!g.has(c)}).map(t=>t?.id),[l,g]),b=a.useCallback(()=>{localStorage.removeItem(`roadmap-${o}-${m?.id}-progress`),localStorage.removeItem(`roadmap-${o}-${m?.id}-favorite`)},[o,m]),{mutate:P,isPending:j}=R({mutationFn:s=>{const t=h.filter(c=>!s.topicIds.includes(c));return k(`/v1-save-personalization/${o}`,{personalized:{...s,topicIds:t}})},onError:s=>{d.error(s?.message??"Failed to save personalization")},onSuccess:()=>{b(),w(),U(),d.success("Personalization saved successfully")}},v),{generatePersonalizedRoadmap:z,status:T}=_({roadmapId:o,onStart:()=>{p(!1)},onError:s=>{for(const t of h)y(t,"pending")},onData:s=>{const{topicIds:t}=s;t.forEach(c=>{g.has(c)||y(c,"pending")})},onFinish:s=>{const{topicIds:t,information:c}=s;P({topicIds:t,information:c})}}),{mutate:C,isPending:F}=R({mutationFn:()=>k(`/v1-clear-roadmap-personalization/${o}`,{}),onError:s=>{d.error(s?.message??"Failed to clear personalization")},onSuccess:()=>{h.forEach(s=>{y(s,"pending")}),n(!1),d.success("Personalization cleared successfully."),w()}},v),I=T!=="idle"||F||j,M=s=>{if(n(s),!s)h.forEach(c=>{y(c,"pending")});else if(r?.personalized){const{topicIds:t}=r.personalized;h.forEach(c=>{t.includes(c)?y(c,"skipped"):y(c,"pending")})}};return e.jsxs(e.Fragment,{children:[u&&e.jsx(re,{info:r?.personalized?.information??"",onClose:()=>p(!1),onSubmit:s=>{for(const t of h)y(t,"skipped");z(s)},onClearProgress:()=>{p(!1),C()}}),r?.personalized?.information?e.jsx(oe,{isPersonalized:i,onToggle:M,onEdit:()=>p(!0),onRemove:()=>{confirm("Are you sure you want to remove personalization?")&&C()}}):e.jsx("button",{className:"group hidden sm:inline-flex items-center gap-1.5 border-b-2 border-b-transparent pb-2.5 text-sm font-normal text-gray-500 transition-colors hover:text-black",onClick:()=>{if(!D()){Y();return}p(!0)},disabled:I,children:I?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 shrink-0 animate-spin"}),e.jsx("span",{children:"Personalizing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{children:"Personalize"}),e.jsx("span",{className:N("ml-0.5 hidden items-center gap-0.5 rounded-full bg-yellow-200 px-2 py-0.5 text-xs font-medium text-black transition-colors sm:flex",{"bg-yellow-200 text-black group-hover:bg-yellow-300":!0}),children:"New"})]})})]})}export{Xe as PersonalizedRoadmap};
