import{j as e}from"./jsx-runtime.D_zvdyIk.js";/* empty css                                 */import{u as U}from"./useQuery.BDS8a8wn.js";import{r as s}from"./index.DatCARk7.js";import{r as B}from"./index.Cfv66hal.js";import{u as Y}from"./use-toast.BdCcSTJE.js";import{q as ce,a as A}from"./query-client.BXTfwa3d.js";import{AITutorLayout as Ne}from"./AITutorLayout.BRrfDD23.js";import{U as X}from"./UpgradeAccountModal.Bf1PhEwX.js";import{h as de,a as re}from"./query-http.YhxTqNi8.js";import{g as me}from"./ai.CwFQCDSa.js";import{generateAIRoadmapFromText as Z,renderFlowJSON as ue}from"./index.BgRaT1MR.js";import{a as G}from"./ai-course.C9pe4RQ2.js";import{r as pe}from"./chat.C-0TRz4N.js";import"./js.cookie.Cz0CWeBA.js";import{g as Se}from"./browser.3c2kCsRM.js";import{i as L,r as Ce}from"./jwt.1xGNZsvU.js";import{L as ee}from"./loader-circle.1OH4z0ap.js";import{c as $}from"./classname.y9b8gBZq.js";import{u as ke}from"./use-outside-click.f1LA7r1K.js";import{M as ge}from"./Modal.B1RqXaQs.js";import{u as W}from"./useMutation.BrRqCquH.js";import{C as Ae}from"./CheckIcon.D4OhQ5l1.js";import{T as Re}from"./Tooltip.BP6rWEsy.js";import{R as he}from"./refresh-ccw.D3XBJq6u.js";import{T as te}from"./trash-2.B2o931ei.js";import{S as fe}from"./send.CNwPxIps.js";import{s as E}from"./popup.CdCAhVM2.js";import{u as Me}from"./use-auth.Bw1nhFr_.js";import{S as V}from"./square-pen.oIdiM-Bb.js";import{S as Ie}from"./settings.DLc89oZt.js";import{S as Le}from"./save.BkNgyNj1.js";import{u as Te,b as xe}from"./billing.CdvAGjKR.js";import{a as oe,m as Pe}from"./markdown.BXNIcYB9.js";import{R as _}from"./RoadmapAIChatCard.D2HPu5W5.js";import{C as ne}from"./RoadmapFloatingChat.CTox2nJW.js";import{g as Ee}from"./is-mobile.CWj1ep7V.js";import{M as Ue}from"./message-circle.gi35PKdE.js";import{B as qe}from"./bot.BOh-sxCh.js";import{X as De}from"./x.ZVxf9pxD.js";import{c as we}from"./createLucideIcon.uNyFMN5K.js";import{L as ie}from"./lock.C0iyFeE_.js";import{C as He}from"./UpdatePersonaModal.DHq1e2hk.js";import"./index.Bz-QvCnq.js";import"./toast.DlejBBdi.js";import"./index.3whys8t3.js";import"./AILimitsPopup.IBd1xV7_.js";import"./number.al1uMBuK.js";import"./gift.ZPnr9qou.js";import"./zap.W9oJWPBR.js";import"./auth.Blx_4y9V.js";import"./DropdownMenu.CS77xgrA.js";import"./Combination.DIpUOS19.js";import"./floating-ui.dom.BG6dflv2.js";import"./fp.esm.D_pnqQn4.js";import"./chevron-right.CrKPBoyZ.js";import"./check.DCsIB_xO.js";import"./chevron-down.C3HM4CLF.js";import"./user-round.BP1hNqEM.js";import"./log-out.u8E82mMZ.js";import"./book-open.D6AjheEV.js";import"./file-text.QnmHb0pX.js";import"./map.D6boQwTM.js";import"./swords.BeJjnBga.js";import"./star.efkPFH5L.js";import"./RoadmapLogo.CJwoV5Wp.js";import"./menu.DgseLi6n.js";import"./UpdatePlanConfirmation.vVGIG51-.js";import"./VerifyUpgrade.DHdhu0dP.js";import"./circle-check-big.DD4Bg2zr.js";import"./use-keydown.UQ-VttR1.js";import"./preload-helper.sN6dSm8X.js";/* empty css                                 */import"./dom.B_TnKQIa.js";import"./slugger.rj1cS6co.js";import"./roadmap.C9m-s_nC.js";import"./TopicDetail.0rOhIF79.js";import"./http.qJhOBTpO.js";import"./resource-progress.CNHeJjXc.js";import"./roadmap.DwTTnFhR.js";import"./index.BHh4vvK5.js";import"./page.DyYQD7MX.js";import"./Spinner.CPY-6wbR.js";import"./GitHubIcon.NZCYHAdm.js";import"./vue.Bx8V6p_T.js";import"./transition.MUZrSsh7.js";import"./wand-sparkles.DH_Id-ff.js";import"./book-open-text.DUZ-qSpq.js";import"./brain.t8-WSjRY.js";import"./CodeBlock.DM3RYXoM.js";import"./use-copy-text.DMdbdIxo.js";import"./copy.IVh-7Rp7.js";import"./index.zZad4t7S.js";import"./heart-handshake.D70r9b2H.js";import"./share.Ho6hSRxU.js";import"./plus.CQTVuaoH.js";import"./person-standing.JwgQFf2-.js";import"./Popover.BEqRNE7W.js";/* empty css                                 */import"./datetime.BHfGb2kO.js";import"./ellipsis-vertical.CxxBP93e.js";import"./use-debounce.2NG_dkht.js";import"./search.D49NcfKq.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],ze=we("arrow-down",Fe);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],Qe=we("circle-alert",Oe);function D(l){return ce({queryKey:["ai-roadmap",l],queryFn:async()=>{const t=await de(`/v1-get-ai-roadmap/${l}`);me(t.data);const{nodes:a,edges:d}=Z(),c=(await ue()).outerHTML;return{...t,svgHtml:c}},enabled:!!l})}async function ye(l){const{term:t,roadmapSlug:a,onLoadingChange:d,onError:m,isForce:c=!1,prompt:o,onDetailsChange:g,onFinish:u,questionAndAnswers:w,onRoadmapSvgChange:p,onStreamingChange:f}=l;d?.(!0),f?.(!1);try{let n=null;if(a&&c?n=await fetch(`https://api.roadmap.sh/v1-regenerate-ai-roadmap/${a}`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({prompt:o})}):n=await fetch("https://api.roadmap.sh/v1-generate-ai-roadmap"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({term:t,isForce:c,customPrompt:o,questionAndAnswers:w}),credentials:"include"}),!n.ok){const i=await n.json();console.error("Error generating course:",i?.message||"Something went wrong"),d?.(!1),m?.(i?.message||"Something went wrong");return}const h=n.body;if(!h){console.error("Failed to get stream from response"),m?.("Something went wrong"),d?.(!1);return}d?.(!1),f?.(!0),await pe(h,{onMessage:async i=>{const j=me(i),{nodes:S,edges:k}=Z(j),v=await ue({nodes:S,edges:k});p?.(v)},onMessageEnd:async()=>{A.invalidateQueries(G()),f?.(!1)},onDetails:async i=>{if(!i?.roadmapId||!i?.roadmapSlug)throw new Error("Invalid details");g?.(i)}}),u?.()}catch(n){m?.(n?.message||"Something went wrong"),console.error("Error in course generation:",n),d?.(!1),f?.(!1)}}function se(l){const{message:t="Please wait..."}=l;return e.jsxs("div",{className:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white py-2 pr-4 pl-3 text-sm",children:[e.jsx(ee,{className:"size-4 animate-spin text-gray-400"}),e.jsx("span",{children:t})]})}function Be(l){const t=localStorage.getItem(l);return t?JSON.parse(t):[]}function $e(l){const{onClose:t,onSubmit:a,title:d="Give AI more context",description:m="Pass additional information to the AI to generate a course outline."}=l,[c,o]=s.useState(""),g=u=>{u.preventDefault(),a(c)};return e.jsx(ge,{onClose:t,wrapperClassName:"rounded-xl max-w-xl w-full h-auto",bodyClassName:"p-6",overlayClassName:"items-start md:items-center",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"mb-2 text-left text-xl font-semibold",children:d}),e.jsx("p",{className:"text-sm text-gray-500",children:m})]}),e.jsxs("form",{className:"flex flex-col gap-2",onSubmit:g,children:[e.jsx("textarea",{id:"prompt",autoFocus:!0,rows:3,value:c,onChange:u=>o(u.target.value),className:"w-full rounded-md border border-gray-200 p-2 placeholder:text-sm focus:outline-black",placeholder:"e.g. make sure to add a section on React hooks","data-clarity-unmask":"true"}),e.jsx("p",{className:"text-sm text-gray-500",children:'Complete the sentence: "I want AI to..."'}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{className:"rounded-md bg-gray-200 px-4 py-2.5 text-sm text-black hover:opacity-80",onClick:t,children:"Cancel"}),e.jsx("button",{type:"submit",disabled:!c.trim(),className:"rounded-md bg-black px-4 py-2.5 text-sm text-white hover:opacity-80 disabled:opacity-50",children:"Modify Prompt"})]})]})]})})}function _e(l,t){return ce({queryKey:["ai-question-suggestions",l],queryFn:()=>t?{questions:t}:de("/v1-ai-question-suggestions",l),enabled:!!l.term&&!!l.format&&!!l.from,refetchOnMount:!1})}function Ge(l){const{term:t,format:a,defaultQuestions:d,questionAnswerChatMessages:m,setQuestionAnswerChatMessages:c,type:o="create",className:g="",from:u="content"}=l,[w,p]=s.useState(d?.length??0),[f,n]=s.useState(""),[h,i]=s.useState("answering"),j=s.useRef(null),S=s.useRef(null),{data:k,isLoading:v}=U(_e({term:t,format:a,from:u},d),A),N=k?.questions[w],I=()=>{j.current&&j.current.scrollTo({top:j.current.scrollHeight,behavior:"instant"})},M=r=>{const x=r.trim();if(!N||!x)return;const y=[...m,{role:"assistant",...N},{role:"user",answer:x}];if(c(y),n(""),!(w<k.questions.length-1)){i("done");return}B.flushSync(()=>{p(w+1),i("answering"),S.current?.focus()}),I()},R=()=>{c([]),p(0),i("answering")},C=r=>{const x=r-1,y=m.slice(0,x);c(y);const T=Math.floor(x/2);p(T),i("answering"),n(""),setTimeout(()=>{S.current?.focus()},0)};return s.useEffect(()=>{I()},[d,o]),e.jsx(e.Fragment,{children:e.jsxs("div",{className:$("relative h-[350px] w-full overflow-hidden rounded-xl border border-gray-200 bg-white",g),children:[v&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white",children:e.jsxs("div",{className:"flex animate-pulse items-center gap-2 rounded-full border border-gray-200 bg-gray-50 p-2 px-4 text-sm",children:[e.jsx(ee,{className:"size-4 animate-spin"}),e.jsx("span",{children:"Generating personalized questions..."})]})}),!v&&h==="done"&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(Ae,{additionalClasses:"size-12"}),e.jsx("p",{className:"mt-3 text-lg font-semibold",children:"Preferences saved"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["You can now start generating ",a]}),e.jsxs("button",{className:"mt-4 flex items-center gap-2 rounded-lg bg-gray-100 px-4 py-1.5 text-sm text-gray-500 hover:bg-gray-200 focus:outline-none",onClick:R,children:[e.jsx(he,{className:"size-3.5"}),"Reanswer questions"]})]})}),!v&&h==="answering"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex h-full w-full flex-col bg-white",children:[e.jsx("div",{ref:j,className:"relative h-full w-full grow overflow-y-auto",children:e.jsx("div",{className:"absolute inset-0 flex flex-col",children:e.jsxs("div",{className:"flex w-full grow flex-col justify-end gap-2 p-2",children:[m.map((r,x)=>e.jsx(le,{role:r.role,question:r.role==="assistant"?r.question:void 0,answer:r.role==="user"?r.answer:void 0,onEdit:r.role==="user"?()=>C(x):void 0},x)),N&&e.jsx(le,{role:"assistant",question:N?.question??"",possibleAnswers:N.possibleAnswers,onAnswerSelect:M})]})})}),!N&&o==="update"&&e.jsx("div",{className:"p-2",children:e.jsxs("button",{className:"flex w-full items-center justify-center gap-2 rounded-lg border border-gray-200 bg-gray-200 p-2 hover:bg-gray-300",onClick:()=>{c([]),p(0),i("answering")},children:[e.jsx(te,{className:"size-4"}),"Reanswer all questions"]})}),N&&e.jsx("div",{className:"p-2",children:e.jsx("div",{className:"rounded-lg border border-gray-200 bg-white",children:e.jsxs("div",{className:"flex w-full items-center justify-between gap-2 p-2",children:[e.jsx("input",{ref:S,value:f,onChange:r=>n(r.target.value),className:"w-full bg-transparent text-sm focus:outline-none",placeholder:N.possibleAnswers?"Type your answer...":"Or type your own answer...","data-clarity-unmask":"true",autoFocus:!0,onKeyDown:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),M(f),n(""))}}),e.jsx("button",{type:"button",className:"flex size-7 shrink-0 items-center justify-center rounded-md hover:bg-gray-100 focus:outline-none disabled:cursor-not-allowed disabled:opacity-50",disabled:!f,onClick:()=>{M(f),n("")},children:e.jsx(fe,{className:"size-4"})})]})})})]})})]})})}function le(l){const{role:t,question:a,answer:d,possibleAnswers:m,onAnswerSelect:c,onEdit:o}=l,g=m&&m.length>0;return e.jsxs("div",{className:$("flex w-fit items-center gap-2 rounded-lg border p-2 text-pretty",t==="user"&&"self-end border-gray-200 bg-gray-300/30",t==="assistant"&&"border-yellow-200 bg-yellow-300/30"),children:[t==="assistant"&&e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:$(g&&"mb-2"),children:a}),g&&c&&e.jsx("div",{className:"mt-2",children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:m.map(u=>e.jsx("button",{type:"button",className:"cursor-pointer rounded-md border border-yellow-300/50 bg-white/70 px-2 py-1 text-xs text-gray-700 hover:bg-white hover:shadow-sm focus:outline-none",onClick:()=>{c(u)},children:u},u))})})]}),t==="user"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm",children:d}),o&&e.jsxs("div",{className:"group relative",children:[e.jsx("button",{type:"button",className:"flex size-6 shrink-0 items-center justify-center rounded-md text-gray-500 opacity-70 hover:bg-gray-100 hover:opacity-100 focus:outline-none",onClick:o,children:e.jsx(te,{className:"size-4"})}),e.jsx(Re,{additionalClass:"-translate-y-2",position:"top-right",children:"Reanswer after this point"})]})]})]})}function Ke(l){const{onClose:t,questionAndAnswers:a,term:d,format:m,onUpdatePreferences:c,isUpdating:o}=l,[g,u]=s.useState(a||[]),w=a?.filter(h=>h.role==="assistant").map(h=>({question:h.question,possibleAnswers:h.possibleAnswers})),p=s.useMemo(()=>JSON.stringify(g)!==JSON.stringify(a),[g,a]);console.log(g),console.log(a);const n=g.filter(h=>h.role==="user").length===w?.length;return e.jsxs(ge,{onClose:t,bodyClassName:"p-4 flex flex-col gap-4",wrapperClassName:"max-w-xl  h-auto",overlayClassName:"items-start md:items-center",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-lg font-medium",children:"Update Preferences"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Update your preferences for better content"})]}),e.jsx(Ge,{term:d,format:m,questionAnswerChatMessages:g,setQuestionAnswerChatMessages:u,defaultQuestions:w,onGenerateNow:()=>{c(g)},className:"-mx-2 h-[400px] border-none p-0",type:"update"}),p&&n&&e.jsx("button",{className:"rounded-lg bg-black px-4 py-2 text-white hover:opacity-80 disabled:opacity-50",disabled:o||!p,onClick:()=>{c(g)},children:o?"Updating...":"Apply preferences"})]})}function Je(l){const{onRegenerate:t,roadmapSlug:a}=l,d=Y(),[m,c]=s.useState(!1),[o,g]=s.useState(!1),[u,w]=s.useState(!1),[p,f]=s.useState(!1),n=Me(),h=s.useRef(null);ke(h,()=>c(!1));const{data:i}=U(D(a),A),{mutate:j,isPending:S}=W({mutationFn:r=>re(`/v1-update-ai-roadmap-preferences/${a}`,{questionAndAnswers:r}),onSuccess:(r,x)=>{A.setQueryData(D(a).queryKey,y=>y&&{...y,questionAndAnswers:x}),f(!1),c(!1),t()}},A),k=async()=>{const{nodes:r,edges:x}=Z(i?.data||"");return re(`/v1-save-ai-roadmap/${i?._id}`,{title:i?.term,nodes:r.map(y=>({...y,width:void 0,height:void 0,style:{...y.style,width:void 0,height:void 0},measured:{width:void 0,height:void 0}})),edges:x})},{mutate:v,isPending:N}=W({mutationFn:k,onSuccess:r=>{if(!r?.roadmapId){d.error("Something went wrong");return}window.location.href=`/r/${r?.roadmapSlug}`}},A),{mutate:I,isPending:M}=W({mutationFn:k,onSuccess:r=>{if(!r?.roadmapId){d.error("Something went wrong");return}window.open(`https://draw.roadmap.sh/${r?.roadmapId}`,"_blank")}},A),R=n?.id===i?.userId,C=i?.questionAndAnswers&&i.questionAndAnswers.length>0&&R;return e.jsxs(e.Fragment,{children:[o&&e.jsx(X,{onClose:()=>{g(!1)}}),u&&e.jsx($e,{description:"Pass additional information to the AI to generate a roadmap.",onClose:()=>w(!1),onSubmit:r=>{w(!1),t(r)}}),p&&e.jsx(Ke,{onClose:()=>f(!1),questionAndAnswers:i?.questionAndAnswers,term:i?.term||"",format:"roadmap",onUpdatePreferences:r=>{j(r)},isUpdating:S}),e.jsxs("div",{ref:h,className:"relative flex items-stretch",children:[e.jsx("button",{className:$("rounded-md px-2.5 text-gray-400 hover:text-black",{"text-black":m}),onClick:()=>c(!m),children:e.jsx(V,{className:"text-current",size:16,strokeWidth:2.5})}),m&&e.jsxs("div",{className:"absolute top-full right-0 min-w-[190px] translate-y-1 overflow-hidden rounded-md border border-gray-200 bg-white shadow-md",children:[R&&e.jsxs(e.Fragment,{children:[C&&e.jsx(Q,{onClick:()=>{if(!L()){E();return}c(!1),f(!0)},icon:Ie,label:"Update Preferences"}),e.jsx(Q,{onClick:()=>{if(!L()){E();return}c(!1),t()},icon:he,label:"Regenerate"}),e.jsx(Q,{onClick:()=>{if(!L()){E();return}c(!1),w(!0)},icon:V,label:"Modify Prompt"}),e.jsx("hr",{className:"my-1 border-gray-200"})]}),e.jsx(Q,{onClick:()=>{if(!L()){E();return}v()},icon:Le,label:"Start Learning",isLoading:N}),e.jsx(Q,{onClick:()=>{if(!L()){E();return}I()},icon:V,label:"Edit in Editor",isLoading:M})]})]})]})}function Q(l){const{onClick:t,isLoading:a,icon:d,label:m}=l;return e.jsxs("button",{className:"flex w-full items-center gap-2.5 px-3 py-2 text-left text-sm text-gray-600 hover:bg-gray-100",onClick:t,disabled:a,children:[a?e.jsx(ee,{className:"animate-spin",size:16,strokeWidth:2.5}):e.jsx(d,{size:16,className:"text-gray-400",strokeWidth:2.5}),m]})}function We(l){const t=l?.closest("g")||{},a=t?.dataset?.nodeId,d=t?.dataset?.type,m=t?.dataset?.title,c=t?.dataset?.parentTitle,o=t?.dataset?.parentId;return!a||!d?null:{nodeId:a,nodeType:d,targetGroup:t,nodeTitle:m,parentTitle:c,parentId:o}}const Ve=["topic","subtopic","button","link-item"];function be(l){const{isLoading:t,svgHtml:a,onRegenerate:d,roadmapSlug:m,onNodeClick:c}=l,o=s.useCallback(g=>{if(t)return;const u=g.target,{nodeId:w,nodeType:p,targetGroup:f,nodeTitle:n,parentTitle:h}=We(u)||{};if(!(!w||!p||!Ve.includes(p)||!n)){if(p==="button"||p==="link-item"){const i=f?.dataset?.link||"";i.startsWith("http")?window.open(i,"_blank"):window.location.href=i;return}c?.({nodeId:w,nodeType:p,nodeTitle:n,...p==="subtopic"&&{parentTitle:h}})}},[t,c]);return e.jsxs("div",{className:$("relative mx-auto w-full max-w-7xl",t&&"min-h-full"),children:[e.jsx("div",{id:"roadmap-container",className:"relative min-h-[400px] [&>svg]:mx-auto",dangerouslySetInnerHTML:{__html:a},onClick:o}),t&&!a&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(se,{message:"Please wait..."})}),d&&!t&&m&&e.jsx("div",{className:"absolute top-4 right-4",children:e.jsx(Je,{onRegenerate:d,roadmapSlug:m})})]})}function Ye(l){const{onRoadmapSlugChange:t}=l,[a,d]=s.useState(!0),[m,c]=s.useState(!1),[o,g]=s.useState(""),[u,w]=s.useState(!1),[p,f]=s.useState(""),[n,h]=s.useState(""),i=s.useRef(null),{isPaidUser:j,isLoading:S}=Te(),{data:k,isLoading:v}=U(G(),A),N=S||v;s.useEffect(()=>{if(N)return;if(!j&&k&&k?.roadmap?.used>=k?.roadmap?.limit){g("You have reached the limit for this format"),d(!1),w(!0);return}const R=Se(),C=R?.term;if(R?.src,!C)return;let r=[];const x=R?.id;x&&(r=Be(x)),I({term:C,questionAndAnswers:r})},[N,j]);const I=async R=>{const{term:C,isForce:r,prompt:x,questionAndAnswers:y}=R;if(!L()){window.location.href="/ai";return}await ye({term:C,isForce:r,prompt:x,questionAndAnswers:y,onDetailsChange:T=>{const{roadmapId:H,roadmapSlug:F,title:z,userId:K}=T,O={_id:H,userId:K,title:z,term:C,data:n,questionAndAnswers:y,viewCount:0,svgHtml:i.current||"",lastVisitedAt:new Date,createdAt:new Date,updatedAt:new Date};A.setQueryData(D(F).queryKey,O),t?.(F),window.history.replaceState(null,"",`/ai-roadmaps/${F}`)},onLoadingChange:d,onError:g,onStreamingChange:c,onRoadmapSvgChange:T=>{const H=T.outerHTML;i.current=H,f(H)}})},M=u?e.jsx(X,{onClose:()=>{window.location.href="/ai"}}):null;return o?e.jsxs(e.Fragment,{children:[M,e.jsx("div",{className:"text-red-500",children:o})]}):a?e.jsxs(e.Fragment,{children:[M,e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:e.jsx(se,{message:"Please wait..."})})]}):e.jsxs(e.Fragment,{children:[M,e.jsx(be,{isLoading:a,svgHtml:p})]})}function Xe(l){const{endpoint:t,initialMessages:a,onError:d,data:m={},onFinish:c}=l,o=s.useRef(null),[g,u]=s.useState(a||[]),[w,p]=s.useState(null),[f,n]=s.useState("idle"),h=s.useCallback(async j=>{try{n("loading"),o.current?.abort(),o.current=new AbortController;const S=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:j,...m}),signal:o.current?.signal,credentials:"include"});if(!S.ok){const v=await S.json();throw n("error"),u([...j].slice(0,j.length-1)),v.status===401&&(Ce(),window.location.reload()),new Error(v?.message||"Something went wrong")}const k=S.body;if(!k)throw n("error"),u([...j].slice(0,j.length-1)),new Error("Something went wrong");await pe(k,{onMessage:async v=>{const N=await oe(v);B.flushSync(()=>{n("streaming"),p(N)})},onMessageEnd:async v=>{const N=await oe(v);B.flushSync(()=>{p(null),n("ready"),u(I=>[...I,{role:"assistant",content:v,html:N}])})}}),n("idle"),o.current=null,c?.()}catch(S){if(o.current?.signal.aborted)return;d?.(S),n("error")}},[t,d]),i=s.useCallback(()=>{o.current&&(o.current.abort(),o.current=null)},[]);return{messages:g,setMessages:u,sendMessages:h,status:f,streamedMessageHtml:w,stop:i}}function Ze(l){const{roadmapSlug:t,isRoadmapLoading:a,onUpgrade:d,aiChatActionsRef:m}=l,c=Y(),o=s.useRef(null),g=s.useRef(null),[u,w]=s.useState(""),[p,f]=s.useState(!1),[n,h]=s.useState(!0),[i,j]=s.useState(!1),{data:S,isLoading:k,refetch:v}=U(G(),A),{data:N,isLoading:I}=U(xe(),A),M=(S?.used||0)>=(S?.limit||0),R=N?.status==="active",{messages:C,status:r,streamedMessageHtml:x,sendMessages:y,setMessages:T,stop:H}=Xe({endpoint:"https://api.roadmap.sh/v1-ai-roadmap-chat",onError:b=>{console.error(b),c.error(b?.message||"Something went wrong")},data:{aiRoadmapSlug:t},onFinish:()=>{v()}}),F=s.useCallback((b="smooth")=>{o.current?.scrollTo({top:o.current.scrollHeight,behavior:b})},[o]),z=r==="streaming",K=C.length>0,O=s.useCallback(b=>{const P=b||u;if(!L()){E();return}if(z)return;const q=[...C,{role:"user",content:P,html:Pe(P)}];B.flushSync(()=>{T(q)}),y(q),w(""),setTimeout(()=>{F("smooth")},0)},[u,z,C,y,T]),J=s.useCallback(()=>{const b=o.current;if(!b)return;const{scrollTop:P,scrollHeight:q,clientHeight:je}=b,ve=P+je>=q-50;f(!ve&&C.length>0)},[C.length]);s.useEffect(()=>{const b=o.current;if(b)return b.addEventListener("scroll",J),()=>b.removeEventListener("scroll",J)},[J]);const ae=a||k||I;return s.useLayoutEffect(()=>{const b=Ee(),P=["sm","md"].includes(b);if(P)h(!P);else{const q=localStorage.getItem("chat-history-sidebar-open");h(q===null?!0:q==="true")}j(P)},[]),s.useEffect(()=>{i||localStorage.setItem("chat-history-sidebar-open",n.toString())},[n,i]),s.useImperativeHandle(m,()=>({handleNodeClick:b=>{O(`Explain what is "${b.nodeTitle}" topic in detail.`)}})),n?e.jsxs("div",{className:"absolute inset-0 flex h-full w-full max-w-full flex-col overflow-hidden border-l border-gray-200 bg-white md:relative md:max-w-[40%]",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 border-b border-gray-200 bg-white p-2",children:[e.jsxs("h2",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(qe,{className:"h-4 w-4"}),"AI Roadmap"]}),e.jsx("button",{className:"mr-2 flex size-5 items-center justify-center rounded-md text-gray-500 hover:bg-gray-300 md:hidden",onClick:()=>{h(!1)},children:e.jsx(De,{className:"h-3.5 w-3.5"})})]}),ae&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100",children:e.jsx(se,{message:"Loading..."})}),!ae&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"relative grow overflow-y-auto",ref:o,children:e.jsx("div",{className:"absolute inset-0 flex flex-col",children:e.jsx("div",{className:"relative flex grow flex-col justify-end",children:e.jsxs("div",{className:"flex flex-col justify-end gap-2 px-3 py-2",children:[e.jsx(_,{role:"assistant",html:"Hello, how can I help you today?",isIntro:!0}),C.map((b,P)=>e.jsx(_,{...b},`chat-${P}`)),r==="streaming"&&!x&&e.jsx(_,{role:"assistant",html:"Thinking..."}),r==="streaming"&&x&&e.jsx(_,{role:"assistant",html:x})]})})})}),(K||p)&&e.jsxs("div",{className:"flex flex-row justify-between gap-2 border-t border-gray-200 px-3 py-2",children:[e.jsx(ne,{icon:e.jsx(te,{className:"h-3.5 w-3.5"}),className:"rounded-md bg-gray-200 py-1 pr-2 pl-1.5 text-gray-500 hover:bg-gray-300",onClick:()=>{T([])},children:"Clear"}),p&&e.jsx(ne,{icon:e.jsx(ze,{className:"h-3.5 w-3.5"}),className:"rounded-md bg-gray-200 py-1 pr-2 pl-1.5 text-gray-500 hover:bg-gray-300",onClick:()=>{F("smooth")},children:"Scroll to bottom"})]}),e.jsxs("div",{className:"relative flex items-center border-t border-gray-200 text-sm",children:[M&&L()&&e.jsxs("div",{className:"absolute inset-0 z-10 flex items-center justify-center gap-2 bg-black text-white",children:[e.jsx(ie,{className:"size-4 cursor-not-allowed",strokeWidth:2.5}),e.jsxs("p",{className:"cursor-not-allowed",children:["Limit reached for today",R?". Please wait until tomorrow.":""]}),!R&&e.jsx("button",{onClick:()=>{d?.()},className:"rounded-md bg-white px-2 py-1 text-xs font-medium text-black hover:bg-gray-300",children:"Upgrade for more"})]}),!L()&&e.jsxs("div",{className:"absolute inset-0 z-10 flex items-center justify-center gap-2 bg-black text-white",children:[e.jsx(ie,{className:"size-4 cursor-not-allowed",strokeWidth:2.5}),e.jsx("p",{className:"cursor-not-allowed",children:"Please login to continue"}),e.jsx("button",{onClick:()=>{E()},className:"rounded-md bg-white px-2 py-1 text-xs font-medium text-black hover:bg-gray-300",children:"Login / Register"})]}),e.jsx("input",{ref:g,type:"text",value:u,onChange:b=>w(b.target.value),autoFocus:!0,"data-clarity-unmask":"true",onKeyDown:b=>{if(b.key==="Enter"){if(b.preventDefault(),z)return;O()}},placeholder:"Ask me anything about this roadmap...",className:"w-full resize-none px-3 py-4 outline-none"}),e.jsx("button",{className:"absolute top-1/2 right-2 -translate-y-1/2 p-1 text-zinc-500 hover:text-black disabled:opacity-50",onClick:()=>{if(!L()){E();return}if(r!=="idle"){H();return}O()},children:z?e.jsx(He,{className:"h-4 w-4"}):e.jsx(fe,{className:"h-4 w-4"})})]})]})]}):e.jsx("div",{className:"absolute inset-x-0 bottom-0 flex justify-center p-2",children:e.jsxs("button",{className:"flex items-center justify-center gap-2 rounded-full bg-black px-4 py-2 text-white shadow",onClick:()=>{h(!0)},children:[e.jsx(Ue,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:"Open Chat"})]})})}function Ws(l){const{roadmapSlug:t}=l,[a,d]=s.useState(t),m=Y(),[c,o]=s.useState(!1),[g,u]=s.useState(!1),[w,p]=s.useState(null),f=s.useRef(null),{data:n,isLoading:h,error:i}=U(D(a),A),{data:j,isLoading:S,refetch:k}=U(G(),A),{data:v,isLoading:N}=U(xe(),A),I=(j?.used||0)>=(j?.limit||0),M=v?.status==="active",R=async x=>{if(!L()){E();return}if(!M&&I){o(!0);return}B.flushSync(()=>{u(!0),p(null)}),A.cancelQueries(D(a)),A.setQueryData(D(a).queryKey,y=>y&&{...y,data:"",svgHtml:""}),p(""),await ye({roadmapSlug:n?.slug||"",term:n?.term||"",prompt:x,isForce:!0,onStreamingChange:u,onRoadmapSvgChange:y=>{p(y.outerHTML)},onError:y=>{m.error(y)},onFinish:()=>{u(!1),k(),A.invalidateQueries(D(a))}})},C=h||g||S||N,r=s.useCallback(x=>{f.current?.handleNodeClick(x)},[f]);return e.jsxs(Ne,{wrapperClassName:"flex-row p-0 lg:p-0 overflow-hidden relative bg-white",containerClassName:"h-[calc(100vh-49px)] overflow-hidden relative",children:[c&&e.jsx(X,{onClose:()=>o(!1)}),!C&&i&&e.jsx("div",{className:"absolute inset-0 z-10 flex h-full flex-col items-center justify-center bg-white",children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-2",children:[e.jsx(Qe,{className:"size-10 text-gray-500"}),e.jsx("p",{className:"text-center",children:i?.message||"Something went wrong"})]})}),e.jsxs("div",{className:"grow overflow-y-auto p-4 pt-0",children:[a&&!i&&e.jsx(be,{svgHtml:w??n?.svgHtml??"",isLoading:C,onRegenerate:R,roadmapSlug:a,onNodeClick:r}),!a&&!i&&e.jsx(Ye,{onRoadmapSlugChange:d})]}),e.jsx(Ze,{roadmapSlug:a,isRoadmapLoading:!n,onUpgrade:()=>o(!0),aiChatActionsRef:f})]})}export{Ws as AIRoadmap};
